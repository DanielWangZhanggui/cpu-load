box:
  id: openjdk
  tag: 8u141-jdk

build:
  steps:
    - java/maven:
      version: 3.5.2
      goals: clean compile
    - java/maven:
      version: 3.5.2
      goals: install
      cache_repo: true
publish:
  box: 
    id: tomcat
    tag: 8.5.23-jre8
  steps:
    - script: 
      name: Build Image
      code: |
        rm -rf /usr/local/tomcat/webapps/*
        cp ./target/cpu-load-0.0.1-SNAPSHOT.war /usr/local/tomcat/webapps/ROOT.war
    - internal/docker-push:
      username: $DOCKER_USER
      password: $DOCKER_PASSWORD
      repository: burning1docker/cpuload
      tag: V2
      ports: 8080
      cmd: "/usr/local/tomcat/bin/catalina.sh run"
deploy:
    steps:
      - kubectl:
        server: $K8MASTER
        token: $K8TOKEN
        insecure-skip-tls-verify: true
        command: set image deployments/cpuloadv2 cpuload=burning1docker/cpuload:V2
    